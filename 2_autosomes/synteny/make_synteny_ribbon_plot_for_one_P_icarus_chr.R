

library(dplyr)
setwd("/Users/cw22/Documents/transfer_folder/GitHub_projects/polyommatus_atlantica/1_genomes")
# cutoff of block in terms of same strand and stuff, and distance until next ortholog

busco1 <- 'Polyommatus_icarus.OW569327.1.tsv' 
busco_list <- 'Polyommatus_atlantica.tsv'
chrom1 <- 'Polyommatus_icarus.OW569327.1.auto_generated.tsv' 
chrom_list <- 'Polyommatus_icarus.OW569327.1_vs_P_atlantica.auto_generated.tsv' 
output_prefix <- 'P_icarus.OW569327.1_vs_P_atlantica'
merians <- 'Merian_elements_full_table.tsv'
merians_df <- read.csv(merians, sep='\t', header=FALSE)[, c(1, 3)]
colnames(merians_df) <- c('busco', 'merian')
### specify arguments ###
minimum_buscos <- 3
busco1 <- busco1
busco_list = busco_list
chrom_list = chrom_list

print('[+] Processing list of query file(s):')
print(busco_list)

chrom1 <- chrom1 # REF
source('synteny_plotter_helper_functions.R') # import functions

### specify parameters

gap=6
show_outline = TRUE

### read in data ###

# TODO: allow for algs in the arguments
# algs <- read.csv(args$alg_file, sep='\t', header=FALSE)[,c(1,3)]
# colnames(algs) <- c('busco', 'alg')
# alignments <- merge(alignments, algs, by='busco')

R_df <- read_buscos(busco1, 'R')
busco1_df <- R_df
#Q_df <- read_buscos(args$busco2, 'Q') 
R_chromosomes <- read.table(chrom1, sep = '\t', header = TRUE)
#Q_chromosomes <- read.table(args$chrom2, sep = '\t', header = TRUE)
R_chromosomes <- R_chromosomes %>% arrange(order)
R_filt <- R_df %>% group_by(chrR) %>% filter(n() > minimum_buscos) %>% ungroup()
busco1_chr <- R_chromosomes <- R_chromosomes %>% filter(chr %in% R_filt$chrR) 

chr_offset = max(busco1_df$Rend) /2 # make chr offset 50% of the largest chr size in the ref chr set
# NB: using ref genome as a proxy for chr lengths in other genomes too



make_alignment_table <- function(R_df, R_chromosomes, Q_df, Q_chromosomes){
  alignments <- merge(Q_df, R_df, by='busco')
  # apply any filters
  alignments <- alignments %>% group_by(chrR) %>% filter(n() > minimum_buscos) %>% ungroup()
  R_chromosomes <- R_chromosomes %>% filter(chr %in% alignments$chrR)  
  Q_chromosomes <- Q_chromosomes %>% filter(chr %in% alignments$chrQ) 
  R_chromosomes <- R_chromosomes %>% arrange(order)
  chr_order_R <- R_chromosomes$chr # extract order of chr
  Q_chromosomes <- Q_chromosomes %>% arrange(order)
  chr_order_Q <- Q_chromosomes$chr #extract order of chr
  # print(Q_chromosomes)
  # print(chr_order_Q)
  #print('R_chr:') 
  #print(R_chromosomes)
  #print('chr_order_R')
  #print(chr_order_R)
  alignments$alg <- NA
  alignments <- perform_inverts(alignments, Q_chromosomes) 
  offset_alignments_Q <- offset_chr(alignments, 'Q', chr_offset, chr_order_Q)
  offset_alignments_RQ <- offset_chr(offset_alignments_Q$df, 'R', chr_offset, chr_order_R)
  alignments <- offset_alignments_RQ$df
  offset_list_R <- offset_alignments_RQ$offset_list
  offset_list_Q <- offset_alignments_Q$offset_list
  output_list <- list('alignments' = alignments, 'chr_order_R' = chr_order_R, 'chr_order_Q'=chr_order_Q,
                      'offset_list_R'=offset_list_R, 'offset_list_Q'=offset_list_Q)
  return(output_list)
}

counter = 1
max_ends <- list()
max_chr_set <- 'R'
processed_Q_list <- list()

#busco_list = c("marcela_data/xbTriDera4_full_table.tsv")
temp_R_chromosomes <- R_chromosomes
for (i in busco_list){
  #  temp_R_chromosomes <- R_chromosomes
  Q_df <- read_buscos(i, 'Q')  
  Q_chromosomes <- read.table(chrom_list[counter], sep = '\t', header = TRUE)
  # the following three lines have been commented out as now query_chr_file is now generated with an auto order based on 'dev_generate_chromosome_file.R' before running this script
  #Q_chromosomes_auto <- generate_auto_query_order(temp_R_chromosomes, R_df, Q_df) # - maybe the function needs to be a bit adjusted
  #Q_chromosomes <- Q_chromosomes_auto
  #print(Q_chromosomes_auto)
  # print("ORIGINAL:")
  # print(head(Q_chromosomes))
  # print("AUTOGENERATED:")
  # print(head(Q_chromosomes_auto))
  processed_Q <- make_alignment_table(R_df, temp_R_chromosomes, Q_df, Q_chromosomes)
  alignments <- processed_Q$alignments
  # print(i)
  # print(head(alignments))
  processed_Q_list <- append(processed_Q_list, processed_Q)
  counter = counter + 1
  max_ends <- append(max_ends, max(alignments$Rend))
  max_ends <- append(max_ends, max(alignments$Qend))
  R_df <- Q_df # Q1 becomes ref for next iteration (Q2)
  colnames(R_df) <- c('busco', 'chrR', 'Rstart', 'Rend', 'Rstrand')
  temp_R_chromosomes <- Q_chromosomes
}


if (nrow(busco1_chr) <= 9){
  col_list <- c("#ffc759","#FF7B9C", "#607196", "#BABFD1", '#BACDB0', '#C6E2E9', '#F3D8C7', '#47A8BD','#FFAD69')
} else { 
  col_list <- c('#577590', '#617A8B', '#6B8086', '#748581', '#7E8A7C', '#889077', '#929572', '#9B9A6D',
                '#A5A068', '#AFA563', '#B9AA5E', '#C2AF59', '#CCB554', '#D6BA4F', '#E0BF4A', '#E9C545', 
                '#F3CA40', '#F1C544', '#EFC148', '#EDBC4C', '#EBB84F', '#E9B353', '#E7AF57', '#E5AA5B',
                '#E3A55F', '#E1A163', '#DF9C67', '#DD986A', '#DB936E', '#D98F72', '#D78A76')
  num_remove <- length(col_list) - nrow(busco1_chr)
  if (num_remove > 0){
    set.seed(123) # set a random seed for reproducibility
    indices_to_remove <- sample(length(col_list), num_remove) # get random indices of elements to remove
    my_list_cleaned <- col_list[-indices_to_remove] # remove elements from the list using negative indexing
    col_list <- my_list_cleaned
  }
}

if (nrow(busco1_chr) > 31){
  col_list <- c('#577590', '#617A8B', '#6B8086', '#748581', '#7E8A7C', '#889077', '#929572', '#9B9A6D',
                '#A5A068', '#AFA563', '#B9AA5E', '#C2AF59', '#CCB554', '#D6BA4F', '#E0BF4A', '#E9C545', 
                '#F3CA40', '#F1C544', '#EFC148', '#EDBC4C', '#EBB84F', '#E9B353', '#E7AF57', '#E5AA5B',
                '#E3A55F', '#E1A163', '#DF9C67', '#DD986A', '#DB936E', '#D98F72', '#D78A76',
                '#577590', '#617A8B', '#6B8086', '#748581', '#7E8A7C', '#889077', '#929572', '#9B9A6D',
                '#A5A068', '#AFA563', '#B9AA5E', '#C2AF59', '#CCB554', '#D6BA4F', '#E0BF4A', '#E9C545', 
                '#F3CA40', '#F1C544', '#EFC148', '#EDBC4C', '#EBB84F', '#E9B353', '#E7AF57', '#E5AA5B',
                '#E3A55F', '#E1A163', '#DF9C67', '#DD986A', '#DB936E', '#D98F72', '#D78A76',
                '#577590', '#617A8B', '#6B8086', '#748581', '#7E8A7C', '#889077', '#929572', '#9B9A6D',
                '#A5A068', '#AFA563', '#B9AA5E', '#C2AF59', '#CCB554', '#D6BA4F', '#E0BF4A', '#E9C545', 
                '#F3CA40', '#F1C544', '#EFC148', '#EDBC4C', '#EBB84F', '#E9B353', '#E7AF57', '#E5AA5B',
                '#E3A55F', '#E1A163', '#DF9C67', '#DD986A', '#DB936E', '#D98F72', '#D78A76',
                '#577590', '#617A8B', '#6B8086', '#748581', '#7E8A7C', '#889077', '#929572', '#9B9A6D',
                '#A5A068', '#AFA563', '#B9AA5E', '#C2AF59', '#CCB554', '#D6BA4F', '#E0BF4A', '#E9C545', 
                '#F3CA40', '#F1C544', '#EFC148', '#EDBC4C', '#EBB84F', '#E9B353', '#E7AF57', '#E5AA5B',
                '#E3A55F', '#E1A163', '#DF9C67', '#DD986A', '#DB936E', '#D98F72', '#D78A76')
}

col_list_final <- col_list[1:nrow(busco1_chr)] # subset col_list to number needed based on number of busco1 chr
busco1_chr$chr_colour <- col_list_final
busco_2_colour <- busco1_chr[,c(1,4)]
temp <- busco1_df[,c(1,2)]
colnames(temp) <- c('busco', 'chr')
busco_2_colour <- merge(busco_2_colour, temp, by='chr') # assigns a colour to each busco based on which chr its in in busco1

#------------------------------------------------------------------------------#
### colouring specific to synteny plot of one chr ####
busco_2_colour <- merge(busco_2_colour, merians_df, by='busco')
busco_2_colour$chr_colour[busco_2_colour$merian == "M14"] <- "#86BBD8"
busco_2_colour$chr_colour[busco_2_colour$merian == "M26"] <- "#33658A"
busco_2_colour
#------------------------------------------------------------------------------#

print(paste('Col list final:', col_list_final))
print(nrow(busco1_chr))
max_end <- max(unlist(max_ends))
plot_length <- max_end # make plot_length the max of the longest chr set

pdf(paste0(output_prefix, '.pdf'))
print('[+] Generating plot')
plot(0,cex = 0, xlim = c(1, plot_length), ylim = c(((gap+1)*-1*length(busco_list)*2),((gap+1)*length(busco_list)*2)), xlab = "", ylab = "", bty = "n", yaxt="n", xaxt="n")

# I think we don't need this here anymore:
#col_list <- sapply(col_list, t_col, args$alpha)

main_counter <- 1
y_offset <- 0
y_increment <- 17
for (i in busco_list){
  # print(i)
  # print(tail(alignments))
  alignments <- processed_Q_list[[main_counter]]
  chr_order_R <- processed_Q_list[[main_counter+1]]
  chr_order_Q <- processed_Q_list[[main_counter+2]]
  offset_list_R <- processed_Q_list[[main_counter+3]]
  offset_list_Q <- processed_Q_list[[main_counter+4]]
  
  if (max(alignments$Qend) != max_end){ # i.e. if this is the longest chr_set
    if (max(alignments$Rend) != max_end){
      adjustment_length_R <- (max_end - max(alignments$Rend)) / 2 
      adjustment_length_Q <- (max_end - max(alignments$Qend)) / 2 
    }
    else{
      adjustment_length_R <- 0
      adjustment_length_Q <- (max_end - max(alignments$Qend)) / 2 
    }
  }
  else{
    adjustment_length_Q <- 0
    adjustment_length_R <- (max_end - max(alignments$Rend)) / 2
  }
  counter <- 1
  for (i in chr_order_R){
    temp <- alignments[alignments$chrR == i,]
    #plot_one_ref_chr(temp, col_list[[counter]], "red", adjustment_length_R, adjustment_length_Q, y_offset) # use this if want to colour inverted genes in red
    #plot_one_ref_chr(temp, col_list[[counter]], col_list[[counter]], adjustment_length_R, adjustment_length_Q, y_offset)
    plot_one_ref_chr(temp, adjustment_length_R, adjustment_length_Q, y_offset, busco_2_colour, alpha)
    counter <- counter + 1
  }
  
  counter <- 1  # chr outlines for query
  for (i in chr_order_Q){
    temp <- alignments[alignments$chrQ == i,]
    Qfirst <- min(temp$Qstart)
    Qlast <- max(temp$Qend)
    segments(Qfirst+adjustment_length_Q, 1-gap-y_offset, Qlast+adjustment_length_Q, 1-gap-y_offset, lwd = 5)
  }
  
  counter <- 1   # chr outlines for ref
  for (i in chr_order_R){
    temp <- alignments[alignments$chrR == i,]
    Rfirst <- min(temp$Rstart)
    Rlast <- max(temp$Rend)
    segments(Rfirst+adjustment_length_R, gap-y_offset, Rlast+adjustment_length_R, gap-y_offset, lwd = 5)
  }
  
  if (main_counter == 1){ # only need to plot text labels ref if this is the first chr set being plotted, else get duplicates
    counter <- 1    # text labels for ref
    for (i in chr_order_R){
      temp <- alignments[alignments$chrR == i,]
      Rfirst <- min(temp$Rstart)
      Rlast <- max(temp$Rend)
      offset <- offset_list_R[[counter]]
      text(x = ((Rlast+Rfirst+1)/2)+adjustment_length_R, y = gap+3.5, label = i,
           srt = 90, cex=0.5) # Rotation
      counter <- counter + 1
    }
  }
  
  counter <- 1  # text labels for query:
  for (i in chr_order_Q){
    temp <- alignments[alignments$chrQ == i,]
    Qfirst <- min(temp$Qstart)
    Qlast <- max(temp$Qend)
    text(x = ((Qlast+Qfirst+1)/2)+adjustment_length_Q, y = -gap-2-y_offset, label = i,
         srt = 90, cex=0.5) # Rotation
    counter <- counter + 1
  }
  main_counter <- main_counter + 5
  y_offset <- y_offset + y_increment
}

dev.off()
